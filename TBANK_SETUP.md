# Настройка Т-банк эквайринга

## Шаг 1: Получение учетных данных

1. Зарегистрируйтесь в личном кабинете Т-банка: https://securepayments.tbank.ru
2. Получите:
   - `TBANK_MERCHANT_ID` - ID вашего магазина
   - `TBANK_SECRET_KEY` - Секретный ключ для подписи запросов

## Шаг 2: Настройка переменных окружения

Добавьте в `.env`:

```env
TBANK_MERCHANT_ID=your_merchant_id
TBANK_SECRET_KEY=your_secret_key
TBANK_API_URL=https://securepayments.tbank.ru/api/v1
TBANK_SUCCESS_URL=https://your-domain.com/api/payments/tbank/success
TBANK_FAILURE_URL=https://your-domain.com/api/payments/tbank/failure
BASE_URL=https://your-domain.com
```

## Шаг 3: Настройка Webhook

1. В личном кабинете Т-банка найдите раздел "Webhook" или "Callback URL"
2. Укажите URL для callback:
   ```
   https://your-domain.com/api/payments/tbank/callback
   ```
3. Убедитесь, что:
   - Сервер доступен по HTTPS
   - URL доступен извне (не localhost)
   - Порт открыт для входящих соединений

## Шаг 4: Проверка API endpoints

**ВАЖНО**: Точные endpoints и формат запросов могут отличаться в зависимости от версии API Т-банка.

Проверьте документацию:
- https://developer.tbank.ru/eacq/intro/connection
- Или обратитесь в поддержку Т-банка

Возможные варианты endpoints:
- `/api/v1/payment/create` - создание платежа
- `/api/v1/payment/status` - проверка статуса
- `/payment` - редирект на страницу оплаты

## Шаг 5: Тестирование

### Тестовый платеж

1. Используйте тестовые данные карты (уточните в документации Т-банка)
2. Создайте платеж через API:
   ```bash
   POST /api/payments/create
   {
     "deviceId": "test-device",
     "tokensAmount": 100,
     "amount": 99.00
   }
   ```
3. Перейдите по `paymentUrl` и выполните тестовый платеж
4. Проверьте, что webhook получил callback
5. Убедитесь, что токены начислены пользователю

### Проверка логов

Следите за логами сервера:
```bash
# Успешный callback
Т-банк webhook received: {...}
Tokens added for user 1: 100

# Ошибка
Error processing Т-банк webhook: Invalid signature
```

## Шаг 6: Обработка ошибок

### Проблема: Webhook не приходит

**Решения:**
1. Проверьте доступность URL (используйте https://webhook.site для тестирования)
2. Убедитесь, что URL указан правильно в настройках Т-банка
3. Проверьте firewall и настройки сервера

### Проблема: Неверная подпись

**Решения:**
1. Проверьте правильность `TBANK_SECRET_KEY`
2. Убедитесь, что алгоритм подписи соответствует документации Т-банка
3. Проверьте порядок параметров в строке подписи

### Проблема: Платеж создается, но не обрабатывается

**Решения:**
1. Проверьте логи webhook
2. Убедитесь, что статус платежа обновляется в БД
3. Проверьте, что токены начисляются после успешного платежа

## Альтернативные методы интеграции

Т-банк может поддерживать разные способы интеграции:

1. **Редирект на страницу оплаты** (текущая реализация)
   - Пользователь переходит на страницу Т-банка
   - После оплаты возвращается через success/failure URL

2. **Iframe**
   - Платежная форма открывается в iframe
   - Требует настройки CSP заголовков

3. **Мобильный SDK**
   - Для нативных приложений
   - Может потребовать дополнительную настройку

## Безопасность

1. **HTTPS обязателен** для production
2. **Проверка подписи** всех callback запросов
3. **Валидация** всех входящих данных
4. **Логирование** всех платежных операций
5. **Мониторинг** подозрительной активности

## Поддержка

Если возникли проблемы:
1. Проверьте документацию Т-банка
2. Обратитесь в поддержку Т-банка
3. Проверьте логи сервера и базы данных



