# Руководство по тестированию системы токенов

## Предварительные требования

1. **База данных MySQL** должна быть настроена и запущена
2. **Переменные окружения** в `.env` файле:
   ```env
   MYSQL_HOST=localhost
   MYSQL_USER=root
   MYSQL_PASSWORD=your_password
   MYSQL_DATABASE=vissreader
   MYSQL_PORT=3306
   
   TBANK_TERMINAL_KEY=1703150935625DEMO
   TBANK_PASSWORD=xcbixwo8gsjibu6u
   TBANK_API_URL=https://securepayments.tbank.ru/api/v1
   BASE_URL=http://localhost:3000
   ```

3. **Сервер должен быть запущен**:
   ```bash
   npm start
   # или для разработки
   npm run dev
   ```

## Тестовые скрипты

### 1. Автоматические тесты (`test-token-system.js`)

Запускает все основные тесты системы:

```bash
npm run test:tokens
# или
node test-token-system.js
```

**Что тестируется:**
- ✅ Получение баланса токенов (новый пользователь получает 300 токенов)
- ✅ Получение списка тарифов
- ✅ Генерация изображения (списание 10 токенов)
- ✅ Создание платежа
- ✅ Проверка статуса платежа
- ✅ История транзакций
- ✅ Обработка ошибки недостатка токенов

**Ожидаемый результат:**
```
✅ Баланс: 300 токенов
✅ Тарифы получены
✅ Изображение сгенерировано
✅ Баланс уменьшился правильно: 300 → 290
✅ Платеж создан
```

### 2. Интерактивный тест платежа (`test-payment-flow.js`)

Полный цикл тестирования платежа с интерактивным выбором тарифа:

```bash
node test-payment-flow.js
```

**Процесс:**
1. Проверка текущего баланса
2. Выбор тарифа из списка
3. Создание платежа
4. Открытие Payment URL для оплаты
5. Проверка статуса после оплаты
6. Проверка начисления токенов
7. Просмотр истории транзакций

## Ручное тестирование через API

### 1. Получить баланс

```bash
curl "http://localhost:3000/api/payments/balance?deviceId=test-device-123"
```

**Ответ:**
```json
{
  "success": true,
  "balance": 300,
  "userId": 1
}
```

### 2. Получить тарифы

```bash
curl "http://localhost:3000/api/payments/pricing"
```

**Ответ:**
```json
{
  "success": true,
  "pricing": [
    {
      "id": "tier1",
      "tokens": 1000,
      "price": 300.00,
      "label": "1000 токенов",
      "popular": false
    },
    ...
  ]
}
```

### 3. Создать платеж

```bash
curl -X POST "http://localhost:3000/api/payments/create" \
  -H "Content-Type: application/json" \
  -d '{
    "deviceId": "test-device-123",
    "tierId": "tier1"
  }'
```

**Ответ:**
```json
{
  "success": true,
  "paymentId": "payment_1234567890_abc123",
  "paymentUrl": "https://securepayments.tbank.ru/...",
  "amount": 300.00,
  "tokensAmount": 1000,
  "status": "processing"
}
```

### 4. Проверить статус платежа

```bash
curl "http://localhost:3000/api/payments/status/payment_1234567890_abc123"
```

### 5. Генерация изображения

```bash
curl -X POST "http://localhost:3000/api/generate-image" \
  -H "Content-Type: application/json" \
  -d '{
    "deviceId": "test-device-123",
    "bookTitle": "Война и мир",
    "author": "Лев Толстой",
    "textChunk": "Он стоял на балконе..."
  }'
```

**Успешный ответ:**
```json
{
  "success": true,
  "imageUrl": "https://...",
  "promptUsed": "...",
  "tokensRemaining": 290
}
```

**Ошибка недостатка токенов:**
```json
{
  "success": false,
  "error": "Insufficient tokens",
  "balance": 5,
  "required": 10,
  "message": "Недостаточно токенов. У вас 5, требуется 10"
}
```

## Тестирование с Т-банк

### Тестовые данные

- **TerminalKey**: `1703150935625DEMO`
- **Password**: `xcbixwo8gsjibu6u`

### Процесс тестирования платежа

1. **Создайте платеж** через API
2. **Откройте Payment URL** в браузере
3. **Используйте тестовые данные карты** (уточните в документации Т-банка)
4. **Завершите оплату**
5. **Проверьте webhook** - Т-банк должен отправить callback на `/api/payments/tbank/callback`
6. **Проверьте баланс** - токены должны быть начислены

### Проверка webhook

Webhook должен быть доступен по адресу:
```
POST https://your-domain.com/api/payments/tbank/callback
```

Для локального тестирования можно использовать:
- [ngrok](https://ngrok.com/) для создания туннеля
- Или тестировать на production сервере

## Типичные проблемы

### 1. Ошибка подключения к БД

```
Access denied for user ''@'localhost'
```

**Решение:** Проверьте переменные окружения в `.env`:
- `MYSQL_HOST`
- `MYSQL_USER`
- `MYSQL_PASSWORD`
- `MYSQL_DATABASE`

### 2. Сервер не запускается

**Решение:** 
- Проверьте, что порт 3000 свободен
- Проверьте логи ошибок
- Убедитесь, что все зависимости установлены: `npm install`

### 3. Платеж не создается

**Решение:**
- Проверьте `TBANK_TERMINAL_KEY` и `TBANK_PASSWORD` в `.env`
- Проверьте логи сервера на ошибки API Т-банка
- Убедитесь, что `TBANK_API_URL` правильный

### 4. Webhook не приходит

**Решение:**
- Убедитесь, что URL доступен извне (не localhost)
- Проверьте настройки webhook в личном кабинете Т-банка
- Используйте HTTPS для production

## Чеклист тестирования

- [ ] База данных настроена и доступна
- [ ] Сервер запущен и отвечает на запросы
- [ ] Новый пользователь получает 300 токенов
- [ ] Генерация изображения списывает 10 токенов
- [ ] Кэшированные изображения не списывают токены
- [ ] Создание платежа возвращает Payment URL
- [ ] Статус платежа обновляется корректно
- [ ] После успешного платежа токены начисляются
- [ ] История транзакций отображается правильно
- [ ] Ошибка недостатка токенов обрабатывается корректно

## Дополнительные тесты

### Тест кэширования

1. Сгенерируйте изображение для определенного текста
2. Сгенерируйте то же изображение снова
3. Проверьте, что токены не списались второй раз
4. Проверьте, что в ответе есть `"cached": true`

### Тест граничных случаев

1. Попытка генерации при балансе = 0
2. Попытка генерации при балансе = 9 (меньше 10)
3. Создание платежа с несуществующим tierId
4. Проверка статуса несуществующего платежа

## Логирование

Все операции логируются в консоль сервера. Для отладки проверяйте:
- Логи создания платежей
- Логи webhook от Т-банка
- Логи списания/начисления токенов
- Ошибки подключения к БД

## Следующие шаги

После успешного тестирования:
1. Получите production данные от Т-банка
2. Настройте production переменные окружения
3. Настройте webhook URL на production сервере
4. Протестируйте на production с реальными платежами

